-- DarkMirror Classic UI Library (Cool Look - Mobile & PC Friendly)
-- Rebuilt and optimized: dark theme with red accent, smooth animations, shadows, and robust mobile touch handling.
-- API compatible with original: Library:CreateWindow -> Window:CreateTab -> Tab:CreateSection/CreateToggle/CreateSlider/CreateDropdown/CreateTextbox/CreateButton

local Library = {}
Library.__index = Library

-- Global callback
local globalCallback = nil
function Library:SetCallback(func)
    globalCallback = func
end

-- Services
local Players = game:GetService("Players")
local TweenService = game:GetService("TweenService")
local UserInputService = game:GetService("UserInputService")
local RunService = game:GetService("RunService")
local LocalPlayer = Players.LocalPlayer
local playerGui = LocalPlayer:WaitForChild("PlayerGui")

-- Theme
local THEME = {
    bg = Color3.fromRGB(18,18,18),
    panel = Color3.fromRGB(28,28,28),
    accent = Color3.fromRGB(220,50,50),
    accentDark = Color3.fromRGB(160,30,30),
    white = Color3.fromRGB(242,242,242),
    dim = Color3.fromRGB(200,200,200),
    shadowImg = "rbxassetid://1316045217" -- subtle circle shadow asset
}

-- Root GUI
local baseScreenGui = Instance.new("ScreenGui")
baseScreenGui.Name = "DarkMirrorClassicUI_Cool"
baseScreenGui.Parent = playerGui
baseScreenGui.ResetOnSpawn = false

-- Utility creators
local function createUICorner(instance, radius)
    local c = Instance.new("UICorner")
    c.CornerRadius = radius or UDim.new(0, 8)
    c.Parent = instance
    return c
end
local function createUIStroke(instance, color, thickness)
    local s = Instance.new("UIStroke")
    s.Color = color or THEME.accent
    s.Thickness = thickness or 1
    s.Parent = instance
    return s
end
local function createShadow(parent)
    local img = Instance.new("ImageLabel")
    img.AnchorPoint = Vector2.new(0.5,0.5)
    img.Position = UDim2.new(0.5,0.5,0.5,0.5)
    img.Size = UDim2.new(1.12,0,1.18,0)
    img.ZIndex = parent.ZIndex - 1
    img.BackgroundTransparency = 1
    img.Image = THEME.shadowImg
    img.ImageTransparency = 0.78
    img.Parent = parent
    return img
end

local function isPressInput(input)
    return input and (input.UserInputType == Enum.UserInputType.MouseButton1 or input.UserInputType == Enum.UserInputType.Touch)
end

local function isPointInGui(point, gui)
    if not gui or not gui:IsA("GuiObject") then return false end
    local ap = gui.AbsolutePosition
    local asz = gui.AbsoluteSize
    return point.X >= ap.X and point.X <= (ap.X + asz.X) and point.Y >= ap.Y and point.Y <= (ap.Y + asz.Y)
end

-- Robust press handler used for buttons, toggles, dropdowns options etc.
local function attachPressHandler(guiObject, callback)
    if not guiObject or not callback then return end
    local last = 0
    local debounceWindow = 0.22

    local function trigger()
        local now = os.clock()
        if now - last < debounceWindow then return end
        last = now
        pcall(callback)
    end

    local aConn
    if guiObject.Activated then
        aConn = guiObject.Activated:Connect(trigger)
    end
    local mConn
    if guiObject:IsA("GuiButton") then
        mConn = guiObject.MouseButton1Click:Connect(trigger)
    end

    local beganConn
    beganConn = UserInputService.InputBegan:Connect(function(input, processed)
        if input.UserInputType == Enum.UserInputType.Touch or input.UserInputType == Enum.UserInputType.MouseButton1 then
            local pos = input.Position or UserInputService:GetMouseLocation()
            if isPointInGui(pos, guiObject) then
                trigger()
            end
        end
    end)

    local ancestryConn
    ancestryConn = guiObject.AncestryChanged:Connect(function(_, parent)
        if not parent then
            if aConn then aConn:Disconnect() end
            if mConn then mConn:Disconnect() end
            if beganConn then beganConn:Disconnect() end
            if ancestryConn then ancestryConn:Disconnect() end
        end
    end)
end

-- Floating toggle button (draggable)
local floatBtn = Instance.new("ImageButton")
floatBtn.Size = UDim2.new(0,58,0,58)
floatBtn.Position = UDim2.new(0,22,0.5,-29)
floatBtn.AnchorPoint = Vector2.new(0,0.5)
floatBtn.BackgroundColor3 = THEME.panel
floatBtn.Image = ""
floatBtn.Parent = baseScreenGui
createUICorner(floatBtn, UDim.new(0,12))
createShadow(floatBtn)
createUIStroke(floatBtn, Color3.fromRGB(40,40,40),1)

local dragging, dragInput, dragStart, startPos
floatBtn.InputBegan:Connect(function(input)
    if isPressInput(input) then
        dragging = true
        dragStart = input.Position
        startPos = floatBtn.Position
        dragInput = input
        input.Changed:Connect(function()
            if input.UserInputState == Enum.UserInputState.End then
                dragging = false
                dragInput = nil
            end
        end)
    end
end)
floatBtn.InputChanged:Connect(function(input)
    if input.UserInputType == Enum.UserInputType.MouseMovement or input.UserInputType == Enum.UserInputType.Touch then
        dragInput = input
    end
end)
UserInputService.InputChanged:Connect(function(input)
    if input == dragInput and dragging then
        local delta = input.Position - dragStart
        floatBtn.Position = UDim2.new(startPos.X.Scale, startPos.X.Offset + delta.X, startPos.Y.Scale, startPos.Y.Offset + delta.Y)
    end
end)

-- Small icon inside floatBtn
local floatIco = Instance.new("ImageLabel")
floatIco.Size = UDim2.new(0,34,0,34)
floatIco.Position = UDim2.new(0.5,-17,0.5,-17)
floatIco.BackgroundTransparency = 1
floatIco.Image = "rbxassetid://94371101129415" -- placeholder
floatIco.Parent = floatBtn

-- Main window factory
function Library:CreateWindow(guiName, subtitle, version)
    local Window = {}
    Window.__index = Window

    local main = Instance.new("Frame")
    main.Name = guiName or "DarkMirrorClassicUI"
    main.Size = UDim2.new(0,520,0,360)
    main.Position = UDim2.new(0.5,-260,0.5,-180)
    main.BackgroundColor3 = THEME.bg
    main.BorderSizePixel = 0
    main.Parent = baseScreenGui
    createUICorner(main)
    createShadow(main)
    main.ZIndex = 50

    -- Titlebar
    local titleBar = Instance.new("Frame")
    titleBar.Size = UDim2.new(1,0,0,52)
    titleBar.BackgroundTransparency = 0
    titleBar.BackgroundColor3 = THEME.panel
    titleBar.Parent = main
    createUICorner(titleBar, UDim.new(0,10))

    local title = Instance.new("TextLabel")
    title.Text = guiName or "DarkMirrorUI"
    title.Font = Enum.Font.GothamBold
    title.TextSize = 22
    title.TextColor3 = THEME.accent
    title.BackgroundTransparency = 1
    title.Position = UDim2.new(0,18,0,10)
    title.Size = UDim2.new(0,240,0,28)
    title.Parent = titleBar

    local sub = Instance.new("TextLabel")
    sub.Text = subtitle or ""
    sub.Font = Enum.Font.Gotham
    sub.TextSize = 13
    sub.TextColor3 = THEME.dim
    sub.BackgroundTransparency = 1
    sub.Position = UDim2.new(0,18,0,32)
    sub.Size = UDim2.new(0,300,0,16)
    sub.Parent = titleBar

    local ver = Instance.new("TextLabel")
    ver.Text = version or ""
    ver.Font = Enum.Font.GothamBold
    ver.TextSize = 12
    ver.TextColor3 = THEME.dim
    ver.BackgroundTransparency = 1
    ver.Position = UDim2.new(1,-110,0,18)
    ver.Size = UDim2.new(0,96,0,16)
    ver.TextXAlignment = Enum.TextXAlignment.Right
    ver.Parent = titleBar

    -- Dragging main with titlebar
    do
        local draggingWin, dragInputWin, dragStartWin, startPosWin
        titleBar.InputBegan:Connect(function(input)
            if isPressInput(input) then
                draggingWin = true
                dragStartWin = input.Position
                startPosWin = main.Position
                dragInputWin = input
                input.Changed:Connect(function()
                    if input.UserInputState == Enum.UserInputState.End then
                        draggingWin = false
                        dragInputWin = nil
                    end
                end)
            end
        end)
        titleBar.InputChanged:Connect(function(input)
            if input.UserInputType == Enum.UserInputType.MouseMovement or input.UserInputType == Enum.UserInputType.Touch then
                dragInputWin = input
            end
        end)
        UserInputService.InputChanged:Connect(function(input)
            if input == dragInputWin and draggingWin then
                local delta = input.Position - dragStartWin
                main.Position = UDim2.new(startPosWin.X.Scale, startPosWin.X.Offset + delta.X, startPosWin.Y.Scale, startPosWin.Y.Offset + delta.Y)
            end
        end)
    end

    -- Sidebar & content
    local sidebar = Instance.new("ScrollingFrame")
    sidebar.Size = UDim2.new(0,170,1,-60)
    sidebar.Position = UDim2.new(0,0,0,60)
    sidebar.BackgroundTransparency = 0
    sidebar.BackgroundColor3 = THEME.panel
    sidebar.ScrollBarThickness = 6
    sidebar.Parent = main
    createUICorner(sidebar, UDim.new(0,8))
    sidebar.AutomaticCanvasSize = Enum.AutomaticSize.Y
    sidebar.ZIndex = 51

    local sideLayout = Instance.new("UIListLayout", sidebar)
    sideLayout.SortOrder = Enum.SortOrder.LayoutOrder
    sideLayout.Padding = UDim.new(0,8)

    local content = Instance.new("ScrollingFrame")
    content.Size = UDim2.new(1,-186,1,-76)
    content.Position = UDim2.new(0,186,0,76)
    content.BackgroundColor3 = Color3.fromRGB(14,14,14)
    content.BackgroundTransparency = 0
    content.ScrollBarThickness = 8
    content.Parent = main
    content.AutomaticCanvasSize = Enum.AutomaticSize.Y
    content.ZIndex = 51

    local tabFrames = {}
    local sidebarButtons = {}

    -- floatBtn toggles main visibility
    attachPressHandler(floatBtn, function()
        main.Visible = not main.Visible
    end)

    -- CreateTab
    function Window:CreateTab(name)
        local tab = Instance.new("Frame")
        tab.Size = UDim2.new(1,0,1,0)
        tab.BackgroundTransparency = 1
        tab.Parent = content
        tabFrames[name] = tab
        tab.ZIndex = 52

        local layout = Instance.new("UIListLayout", tab)
        layout.FillDirection = Enum.FillDirection.Vertical
        layout.Padding = UDim.new(0,10)

        -- sidebar button
        local sb = Instance.new("TextButton")
        sb.Size = UDim2.new(1,-16,0,42)
        sb.Position = UDim2.new(0,8,0,0)
        sb.BackgroundColor3 = THEME.panel
        sb.Text = name
        sb.Font = Enum.Font.GothamBold
        sb.TextSize = 16
        sb.TextColor3 = THEME.white
        sb.Parent = sidebar
        sb.ZIndex = 53
        createUICorner(sb, UDim.new(0,8))

        -- Selected styling
        local function selectTab()
            for _,f in pairs(tabFrames) do f.Visible = false end
            tab.Visible = true
            for _,b in pairs(sidebarButtons) do b.BackgroundColor3 = THEME.panel; b.TextColor3 = THEME.white end
            sb.BackgroundColor3 = THEME.accentDark
            sb.TextColor3 = THEME.white
        end
        attachPressHandler(sb, selectTab)

        table.insert(sidebarButtons, sb)
        if #sidebarButtons == 1 then
            selectTab()
        end

        local TabAPI = {}
        TabAPI.__index = TabAPI

        local function createRow(parent, labelText, element)
            local row = Instance.new("Frame")
            row.Size = UDim2.new(0.96,0,0, math.max((element.Size and element.Size.Y and element.Size.Y.Offset) or 44, 44))
            row.BackgroundTransparency = 1
            row.LayoutOrder = #parent:GetChildren()
            row.Parent = parent

            local label = Instance.new("TextLabel")
            label.Size = UDim2.new(0.48,0,1,0)
            label.BackgroundTransparency = 1
            label.Text = labelText
            label.Font = Enum.Font.GothamBold
            label.TextSize = 15
            label.TextColor3 = THEME.white
            label.TextXAlignment = Enum.TextXAlignment.Left
            label.Parent = row

            element.Parent = row
            local elW = 0 local elH = 44
            if element.Size and element.Size.X and element.Size.Y then
                elW = element.Size.X.Offset
                elH = element.Size.Y.Offset
            end
            element.Position = UDim2.new(1, -elW - 8, 0.5, -elH/2)
            return row
        end

        function TabAPI:CreateSection(titleText)
            local sec = Instance.new("Frame")
            sec.Size = UDim2.new(0.96,0,0,28)
            sec.BackgroundTransparency = 0
            sec.BackgroundColor3 = THEME.bg
            sec.Parent = tab
            createUICorner(sec, UDim.new(0,6))

            local txt = Instance.new("TextLabel")
            txt.Text = titleText
            txt.Font = Enum.Font.GothamBold
            txt.TextSize = 16
            txt.TextColor3 = THEME.accent
            txt.BackgroundTransparency = 1
            txt.Position = UDim2.new(0,8,0,4)
            txt.Parent = sec
            return sec
        end

        function TabAPI:CreateToggle(name, callback)
            callback = callback or function() end
            local btn = Instance.new("Frame")
            btn.Size = UDim2.new(0,72,0,32)
            btn.BackgroundColor3 = THEME.panel
            btn.Parent = tab
            createUICorner(btn, UDim.new(0,16))

            local track = Instance.new("Frame")
            track.Size = UDim2.new(1,-8,0,16)
            track.Position = UDim2.new(0,4,0.5,-8)
            track.BackgroundColor3 = Color3.fromRGB(60,60,60)
            track.Parent = btn
            createUICorner(track, UDim.new(0,8))

            local thumb = Instance.new("Frame")
            thumb.Size = UDim2.new(0,18,0,18)
            thumb.Position = UDim2.new(0,3,0.5,-9)
            thumb.BackgroundColor3 = THEME.white
            thumb.Parent = btn
            createUICorner(thumb, UDim.new(0,9))

            local state = false
            local function update(now)
                if now then
                    TweenService:Create(track, TweenInfo.new(0.16), {BackgroundColor3 = THEME.accent}):Play()
                    TweenService:Create(thumb, TweenInfo.new(0.16), {Position = UDim2.new(1,-21,0.5,-9)}):Play()
                else
                    TweenService:Create(track, TweenInfo.new(0.16), {BackgroundColor3 = Color3.fromRGB(60,60,60)}):Play()
                    TweenService:Create(thumb, TweenInfo.new(0.16), {Position = UDim2.new(0,3,0.5,-9)}):Play()
                end
            end

            attachPressHandler(btn, function()
                state = not state
                update(state)
                pcall(callback, state)
                if globalCallback then pcall(globalCallback, "Toggle", name, state) end
            end)

            return btn
        end

        function TabAPI:CreateSlider(name, min, max, default, callback)
            if type(default) == "function" and callback == nil then
                callback = default; default = min or 0
            end
            min = min or 0 max = max or 100 default = default or min
            callback = callback or function() end

            local frame = Instance.new("Frame")
            frame.Size = UDim2.new(0,240,0,36)
            frame.BackgroundColor3 = THEME.panel
            frame.Parent = tab
            createUICorner(frame, UDim.new(0,8))

            local track = Instance.new("Frame")
            track.Size = UDim2.new(1,-72,0,8)
            track.Position = UDim2.new(0,12,0.5,-4)
            track.BackgroundColor3 = Color3.fromRGB(70,70,70)
            track.Parent = frame
            createUICorner(track, UDim.new(0,4))

            local thumb = Instance.new("Frame")
            thumb.Size = UDim2.new(0,18,0,18)
            thumb.Position = UDim2.new(0,0,0.5,-9)
            thumb.BackgroundColor3 = THEME.white
            thumb.Parent = frame
            createUICorner(thumb, UDim.new(0,9))

            local valLabel = Instance.new("TextLabel")
            valLabel.Size = UDim2.new(0,56,0,24)
            valLabel.Position = UDim2.new(1,-58,0.5,-12)
            valLabel.BackgroundTransparency = 1
            valLabel.Font = Enum.Font.GothamBold
            valLabel.TextSize = 14
            valLabel.TextColor3 = THEME.white
            valLabel.Text = tostring(default)
            valLabel.Parent = frame

            local draggingInput = nil
            local function setFromX(px)
                local ap = track.AbsolutePosition.X
                local asz = track.AbsoluteSize.X
                if asz <= 0 then return end
                local rel = math.clamp((px - ap)/asz, 0, 1)
                TweenService:Create(thumb, TweenInfo.new(0.06), {Position = UDim2.new(rel, -9, 0.5, -9)}):Play()
                local value = math.floor(min + (max - min) * rel)
                valLabel.Text = tostring(value)
                pcall(callback, value)
                if globalCallback then pcall(globalCallback, "Slider", name, value) end
            end

            local beganConn; local changedConn; local endedConn
            beganConn = UserInputService.InputBegan:Connect(function(input, processed)
                if input.UserInputType == Enum.UserInputType.Touch or input.UserInputType == Enum.UserInputType.MouseButton1 then
                    local pos = input.Position or UserInputService:GetMouseLocation()
                    if isPointInGui(pos, track) then
                        draggingInput = input
                        setFromX(pos.X)
                    end
                end
            end)
            changedConn = UserInputService.InputChanged:Connect(function(input)
                if draggingInput and input == draggingInput then
                    local pos = input.Position or UserInputService:GetMouseLocation()
                    setFromX(pos.X)
                end
            end)
            endedConn = UserInputService.InputEnded:Connect(function(input)
                if draggingInput and input == draggingInput then
                    draggingInput = nil
                end
            end)

            frame.AncestryChanged:Connect(function(_, parent)
                if not parent then
                    if beganConn then beganConn:Disconnect() end
                    if changedConn then changedConn:Disconnect() end
                    if endedConn then endedConn:Disconnect() end
                end
            end)

            -- init
            task.spawn(function()
                local rel = 0
                if max ~= min then rel = (default - min)/(max - min) end
                thumb.Position = UDim2.new(rel, -9, 0.5, -9)
                valLabel.Text = tostring(default)
            end)

            return frame
        end

        function TabAPI:CreateDropdown(name, options, callback)
            options = options or {}
            callback = callback or function() end

            local container = Instance.new("Frame")
            container.Size = UDim2.new(0,200,0,32)
            container.BackgroundColor3 = THEME.panel
            container.Parent = tab
            createUICorner(container, UDim.new(0,8))

            local label = Instance.new("TextLabel")
            label.Size = UDim2.new(1,-36,1,0)
            label.BackgroundTransparency = 1
            label.Text = "Select..."
            label.Font = Enum.Font.GothamBold
            label.TextColor3 = THEME.white
            label.TextSize = 14
            label.Position = UDim2.new(0,8,0,0)
            label.Parent = container

            local arrow = Instance.new("ImageLabel")
            arrow.Size = UDim2.new(0,20,0,20)
            arrow.Position = UDim2.new(1,-28,0.5,-10)
            arrow.BackgroundTransparency = 1
            arrow.Image = "rbxassetid://3926305904" -- chevron
            arrow.Rotation = 90
            arrow.Parent = container

            local list = Instance.new("Frame")
            list.Size = UDim2.new(1,0,0, math.max(0,#options*30))
            list.Position = UDim2.new(0,0,1,6)
            list.BackgroundColor3 = Color3.fromRGB(22,22,22)
            list.Visible = false
            list.ClipsDescendants = true
            list.Parent = container
            createUICorner(list, UDim.new(0,8))

            local layout = Instance.new("UIListLayout", list)
            layout.SortOrder = Enum.SortOrder.LayoutOrder
            layout.Padding = UDim.new(0,2)

            for _,opt in ipairs(options) do
                local b = Instance.new("TextButton")
                b.Size = UDim2.new(1,0,0,28)
                b.BackgroundTransparency = 1
                b.Text = opt
                b.Font = Enum.Font.Gotham
                b.TextColor3 = THEME.white
                b.TextSize = 14
                b.Parent = list
                attachPressHandler(b, function()
                    label.Text = opt
                    list.Visible = false
                    TweenService:Create(arrow, TweenInfo.new(0.18), {Rotation = 90}):Play()
                    pcall(callback, opt)
                    if globalCallback then pcall(globalCallback, "Dropdown", name, opt) end
                end)
            end

            attachPressHandler(container, function()
                list.Visible = not list.Visible
                TweenService:Create(arrow, TweenInfo.new(0.18), {Rotation = list.Visible and 270 or 90}):Play()
            end)

            return container
        end

        function TabAPI:CreateTextbox(name, placeholder, callback)
            callback = callback or function() end
            placeholder = placeholder or ""

            local box = Instance.new("TextBox")
            box.Size = UDim2.new(0,220,0,32)
            box.BackgroundColor3 = Color3.fromRGB(40,40,40)
            box.Text = ""
            box.PlaceholderText = placeholder
            box.Font = Enum.Font.Gotham
            box.TextSize = 14
            box.TextColor3 = THEME.white
            box.ClearTextOnFocus = false
            box.Parent = tab
            createUICorner(box, UDim.new(0,8))

            -- glow when focused
            local glow = Instance.new("UIStroke", box)
            glow.Transparency = 1
            glow.Thickness = 2
            glow.Color = THEME.accent

            box.Focused:Connect(function()
                TweenService:Create(glow, TweenInfo.new(0.15), {Transparency = 0}):Play()
            end)
            box.FocusLost:Connect(function(enter)
                TweenService:Create(glow, TweenInfo.new(0.15), {Transparency = 1}):Play()
                if enter then
                    pcall(callback, box.Text)
                    if globalCallback then pcall(globalCallback, "Textbox", name, box.Text) end
                end
            end)

            -- Ensure touch opens keyboard even if inside ScrollingFrame
            local beganConn
            beganConn = UserInputService.InputBegan:Connect(function(input, processed)
                if input.UserInputType == Enum.UserInputType.Touch or input.UserInputType == Enum.UserInputType.MouseButton1 then
                    local pos = input.Position or UserInputService:GetMouseLocation()
                    if isPointInGui(pos, box) then
                        pcall(function() if box and box.Parent then box:CaptureFocus() end end)
                    end
                end
            end)
            box.AncestryChanged:Connect(function(_, parent)
                if not parent and beganConn then beganConn:Disconnect() end
            end)

            return box
        end

        function TabAPI:CreateButton(name, callback)
            callback = callback or function() end
            local b = Instance.new("TextButton")
            b.Size = UDim2.new(0,140,0,36)
            b.BackgroundColor3 = THEME.accent
            b.Text = name
            b.Font = Enum.Font.GothamBold
            b.TextSize = 15
            b.TextColor3 = THEME.white
            b.Parent = tab
            createUICorner(b, UDim.new(0,10))

            -- shadow
            createShadow(b)

            attachPressHandler(b, function()
                TweenService:Create(b, TweenInfo.new(0.09, Enum.EasingStyle.Quad, Enum.EasingDirection.Out), {BackgroundColor3 = THEME.accentDark}):Play()
                task.delay(0.09, function()
                    TweenService:Create(b, TweenInfo.new(0.12), {BackgroundColor3 = THEME.accent}):Play()
                end)
                pcall(callback)
                if globalCallback then pcall(globalCallback, "Button", name, true) end
            end)

            return b
        end

        return TabAPI
    end

    return Window
end

return Library
